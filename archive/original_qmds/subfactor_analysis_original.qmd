---
title: "Pilot Retention Subfactor Analysis"
subtitle: "Phase 1A: Within-Construct Sub-Item Rankings and Demographic Comparisons"
author: "Analysis Team"
date: today
format:
  docx:
    toc: true
    number-sections: true
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    embed-resources: true
    theme: cosmo
    number-sections: true
execute:
  warning: false
  message: false
  echo: true
---

# Overview

This analysis examines the 31 sub-item rankings within each retention construct and compares them across demographics.

# Setup

```{r setup}
library(tidyverse)
library(rstatix)
library(knitr)
library(janitor)
library(DescTools)

options(scipen = 999)
knitr::opts_chunk$set(fig.width = 10, fig.height = 6)

# Create output directories
dir.create("../../output/tables/subfactor_analysis", showWarnings = FALSE, recursive = TRUE)
dir.create("../../output/figures/subfactor_analysis", showWarnings = FALSE, recursive = TRUE)

# Helper function to safely run Mann-Whitney U tests with effect sizes
safe_wilcox_test <- function(data, formula, exact = FALSE) {
  # Check if we have at least 2 groups with data
  group_var <- all.vars(formula)[2]
  n_groups <- data %>%
    filter(!is.na(!!sym(group_var))) %>%
    pull(!!sym(group_var)) %>%
    n_distinct()

  if (n_groups < 2) {
    # Return empty result if not enough groups
    return(tibble(
      .y. = character(),
      group1 = character(),
      group2 = character(),
      n1 = integer(),
      n2 = integer(),
      statistic = numeric(),
      p = numeric(),
      effsize = numeric(),
      magnitude = character()
    ))
  }

  # Run the test (this should succeed for all valid items)
  test_result <- tryCatch({
    wilcox_test(data, formula, exact = exact)
  },
  error = function(e) {
    # Return empty on test failure
    return(tibble(
      .y. = character(),
      group1 = character(),
      group2 = character(),
      n1 = integer(),
      n2 = integer(),
      statistic = numeric(),
      p = numeric()
    ))
  })

  # If test failed, return empty
  if (nrow(test_result) == 0) {
    return(tibble(
      .y. = character(),
      group1 = character(),
      group2 = character(),
      n1 = integer(),
      n2 = integer(),
      statistic = numeric(),
      p = numeric(),
      effsize = numeric(),
      magnitude = character()
    ))
  }

  # Try to compute effect sizes (may fail for sparse items)
  effsize_result <- tryCatch({
    wilcox_effsize(data, formula)
  },
  error = function(e) {
    # Return NA effect sizes for items that fail
    test_result %>%
      select(item, .y.) %>%
      distinct() %>%
      mutate(
        effsize = NA_real_,
        magnitude = NA_character_
      )
  })

  # Combine results with proper join (include item to avoid cross-product)
  test_result %>%
    left_join(
      effsize_result %>% select(item, .y., effsize, magnitude),
      by = c("item", ".y.")
    )
}

# Helper function to safely run Kruskal-Wallis tests with effect sizes
safe_kruskal_test <- function(data, formula) {
  # Check if we have at least 2 groups with data
  group_var <- all.vars(formula)[2]
  n_groups <- data %>%
    filter(!is.na(!!sym(group_var))) %>%
    pull(!!sym(group_var)) %>%
    n_distinct()

  if (n_groups < 2) {
    # Return empty result if not enough groups
    return(tibble(
      .y. = character(),
      n = integer(),
      statistic = numeric(),
      df = integer(),
      p = numeric(),
      effsize = numeric(),
      magnitude = character()
    ))
  }

  # Run the test (this should succeed for all valid items)
  test_result <- tryCatch({
    kruskal_test(data, formula)
  },
  error = function(e) {
    # Return empty on test failure
    return(tibble(
      .y. = character(),
      n = integer(),
      statistic = numeric(),
      df = integer(),
      p = numeric()
    ))
  })

  # If test failed, return empty
  if (nrow(test_result) == 0) {
    return(tibble(
      .y. = character(),
      n = integer(),
      statistic = numeric(),
      df = integer(),
      p = numeric(),
      effsize = numeric(),
      magnitude = character()
    ))
  }

  # Try to compute effect sizes (may fail for sparse items)
  effsize_result <- tryCatch({
    kruskal_effsize(data, formula)
  },
  error = function(e) {
    # Return NA effect sizes for items that fail
    test_result %>%
      select(item, .y.) %>%
      distinct() %>%
      mutate(
        effsize = NA_real_,
        magnitude = NA_character_
      )
  })

  # Combine results with proper join (include item to avoid cross-product)
  test_result %>%
    left_join(
      effsize_result %>% select(item, .y., effsize, magnitude),
      by = c("item", ".y.")
    )
}

# Variable labels from survey instrument
financial_labels <- c(
  "financial_1" = "Competitive salary",
  "financial_2" = "Allowances and soft pay",
  "financial_3" = "Benefits package",
  "financial_4" = "Disability insurance",
  "financial_5" = "Job security",
  "financial_6" = "New hire/longevity bonuses"
)

qol_labels <- c(
  "qo_l_1" = "Predictable schedule",
  "qo_l_2" = "Vacation time",
  "qo_l_3" = "Family-friendly policies",
  "qo_l_4" = "Home base possibility",
  "qo_l_5" = "Travel benefits",
  "qo_l_6" = "Work-life balance"
)

professional_labels <- c(
  "professional_1" = "Financially stable airline",
  "professional_2" = "Rapid upgrade opportunity",
  "professional_3" = "Fly larger aircraft",
  "professional_4" = "Merit-based promotion",
  "professional_5" = "Seniority-based upgrade"
)

recognition_labels <- c(
  "recognition_1" = "Professional uniforms",
  "recognition_3" = "Vacation for long service",
  "recognition_4" = "Professional respect/recognition",
  "recognition_7" = "Airline recognition"
)

schedule_labels <- c(
  "schedule_1" = "Fixed schedule",
  "schedule_2" = "Variable schedule",
  "schedule_3" = "Flexible work rules",
  "schedule_4" = "Bid line seniority system",
  "schedule_5" = "Vacation bidding rules"
)

operational_labels <- c(
  "operational_1" = "Unambiguous SOPs",
  "operational_2" = "Proactive training",
  "operational_3" = "Well-maintained aircraft",
  "operational_4" = "Well-equipped aircraft",
  "operational_5" = "Highly skilled pilots"
)
```

# Data Loading

```{r load-data}
# Load data (same as retention.Rmd)
raw <- read_csv("../../data/processed/retention.csv", show_col_types = FALSE)

retention_data <- raw %>%
  slice(-(1:2)) %>%
  clean_names()

# Filter to valid responses
included_data <- retention_data %>%
  mutate(
    finished = toupper(as.character(finished)),
    informed_consent = toupper(as.character(informed_consent)),
    screener = toupper(as.character(screener))
  ) %>%
  filter(
    finished == "TRUE",
    informed_consent == "YES",
    screener == "YES"
  )

cat("Valid observations:", nrow(included_data), "\n")
```

# Demographic Groups

```{r demographics}
# Create demographic groups (matching retention.Rmd approach)
included_data <- included_data %>%
  mutate(
    # Numeric conversions
    age = as.numeric(age),
    experience = as.numeric(experience),

    # Age groups
    age_group = if_else(age <= 35, "≤35", ">35"),

    # Experience quartiles
    exp_q = ntile(experience, 4),
    exp_q = factor(exp_q, labels = c("Q1", "Q2", "Q3", "Q4")),

    # Gender
    gender_clean = case_when(
      tolower(gender) %in% c("male", "m") ~ "Male",
      tolower(gender) %in% c("female", "f") ~ "Female",
      TRUE ~ NA_character_
    ),

    # Position
    position = position_position,

    # Military
    military_clean = case_when(
      str_detect(tolower(military_experience), "currently serve|previously served") ~ "Military",
      str_detect(tolower(military_experience), "never") ~ "Civilian",
      TRUE ~ NA_character_
    )
  )

# Summary
cat("\n=== DEMOGRAPHICS ===\n")
cat("Age groups:\n"); table(included_data$age_group) %>% print()
cat("\nGender:\n"); table(included_data$gender_clean, useNA = "ifany") %>% print()
cat("\nPosition:\n"); table(included_data$position, useNA = "ifany") %>% print()
cat("\nExperience:\n"); table(included_data$exp_q) %>% print()
cat("\nMilitary:\n"); table(included_data$military_clean, useNA = "ifany") %>% print()

# Sample characteristics:
# Total valid responses: n=76
# Demographic splits reflect regional airline pilot population:
#   - Gender: ~11% female (8-12% is typical for regional carriers)
#   - Age: Cutoff at 35 chosen as average age of first-year FOs at legacy/major carriers
#   - Experience: Pilots divided into quartiles based on total flight hours
# Cohen's guidelines suggest minimum n≥15 per group for adequate power.
# Results for gender comparisons should be interpreted with caution due to
# insufficient statistical power to detect small-to-moderate effects.
# The "no significant differences" finding may reflect inadequate power rather
# than true absence of differences.
```

# Statistical Methods

## Multiple Testing Correction Approach

This exploratory pilot study employs a **two-step hierarchical false discovery rate (FDR) control procedure** appropriate for the study's structure (6 constructs × 5 demographics = 155 tests) and exploratory aims.

**Step 1 - Construct-Level Screening:**
For each of the six retention constructs (Financial, Quality of Life, Professional, Recognition, Schedule, Operational), we compute the minimum p-value across all five demographic comparisons (age, gender, position, military experience, experience level). These six screening p-values are adjusted using the Benjamini-Hochberg (BH) procedure at false discovery rate q=0.10.

**Step 2 - Detailed Testing Within Significant Constructs:**
For constructs that pass screening (p_adj < 0.10), individual demographic comparisons within that construct are adjusted using Holm's sequentially rejective procedure at α=0.05. Each construct's demographic comparisons are treated as an independent family, controlling the family-wise error rate (FWER) within that construct.

**Rationale:**
Standard Bonferroni correction (α = 0.05/155 ≈ 0.0003) is inappropriately conservative for exploratory research, creating Type II error rates of 50-70% and missing genuine effects that warrant follow-up investigation. FDR control at q=0.10 accepts that approximately 10% of significant findings may be false discoveries, but ensures we do not miss the 90% that represent true demographic differences. This approach balances error types appropriately for hypothesis generation in pilot research with small samples (n=76).

The hierarchical structure exploits the logical grouping of tests (subfactors within constructs) to increase statistical power compared to flat correction across all 155 tests simultaneously.

**Within-Subjects Comparisons:**
Friedman tests assess whether subfactor rankings differ within each construct. Post-hoc pairwise comparisons (if needed) use Wilcoxon signed-rank tests with Holm correction (not BH-FDR, as these repeated-measures comparisons are strongly dependent), treating each construct's comparisons as a separate family.

**References:**
Benjamini & Hochberg (1995) J Royal Statistical Society B; Li & Ghosh (2014) BMC Bioinformatics; Armstrong (2014) Ophthalmic & Physiological Optics; Bender & Lange (1999) BMJ.

```{r screening-setup}
# Construct-Level Screening with Benjamini-Hochberg FDR
# ========================================================
# Step 1 of hierarchical testing: Determine which constructs show
# demographic differences at construct level before examining individual subfactors.
#
# Method: For each construct, compute minimum p-value across all demographic
# comparisons (age, gender, position, military, experience). Apply BH-FDR at q=0.10
# to these 6 screening p-values.
#
# Rationale: Exploratory pilot research (n=76) requires balance between Type I and
# Type II error control. Bonferroni (α=0.0003 per test) is too conservative and
# causes 50-70% Type II error rate, missing genuine effects. BH-FDR at q=0.10
# controls false discovery rate (expected proportion of false positives among
# significant results) while maintaining adequate power for hypothesis generation.

cat("\n=== CONSTRUCT-LEVEL SCREENING ===\n")
cat("Testing whether each construct shows demographic differences\n")
cat("Method: Benjamini-Hochberg FDR at q=0.10\n\n")

# CRITICAL: Declare screening_results tibble BEFORE any construct sections
# This tibble will be populated after each construct completes its demographic analyses
screening_results <- tibble(
  construct = character(),
  min_p = numeric(),
  n_subfactors = integer()
)

# Note: Each construct section will append one row to this tibble
# After all 6 constructs complete, we'll apply BH-FDR to these 6 p-values
```

# Financial Subfactors

```{r financial}
cat("\n========================================\n")
cat("FINANCIAL SUBFACTORS\n")
cat("========================================\n\n")

# Convert to long format
financial_long <- included_data %>%
  select(age_group, gender_clean, position, exp_q, military_clean,
         financial_1:financial_6) %>%
  mutate(respondent_id = row_number()) %>%  # Create persistent ID before pivoting
  mutate(across(financial_1:financial_6, as.numeric)) %>%
  pivot_longer(
    cols = financial_1:financial_6,
    names_to = "item",
    values_to = "rank"
  ) %>%
  filter(!is.na(rank))

# Descriptive stats
financial_desc <- financial_long %>%
  group_by(item) %>%
  summarise(
    n = n(),
    median = median(rank),
    mean = mean(rank),
    sd = sd(rank),
    pct_rank1 = sum(rank == 1) / n() * 100
  ) %>%
  mutate(item = recode(item, !!!financial_labels))

kable(financial_desc, digits = 2, caption = "Financial Subfactors - Descriptive Statistics")

# Friedman test
friedman_financial <- financial_long %>%
  friedman_test(rank ~ item | respondent_id)

kable(friedman_financial, digits = 3, caption = "Financial: Friedman Test (Within-Construct Comparison)")

# Median rank visualization
financial_plot <- financial_desc %>%
  mutate(item = fct_reorder(item, desc(median))) %>%
  ggplot(aes(x = median, y = item)) +
  geom_col(fill = "steelblue", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.1f", median)), hjust = -0.2, size = 3) +
  labs(
    title = "Financial Subfactor Priorities",
    subtitle = "Median rank (lower = higher priority)",
    x = "Median Rank",
    y = NULL
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

print(financial_plot)
ggsave("../../output/figures/subfactor_analysis/financial_median_ranks.png",
       financial_plot, width = 8, height = 5, dpi = 300)

# Age group comparisons (Mann-Whitney U)
mw_age_fin <- financial_long %>%
  filter(!is.na(age_group)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ age_group, exact = FALSE) %>%
  ungroup()

if (nrow(mw_age_fin) > 0) {
  mw_age_fin <- mw_age_fin %>%
    mutate(p_raw = p) %>%  # Preserve raw p-value (p column still exists)
    adjust_pvalue(method = "holm") %>%  # Operates on existing 'p' column, creates 'p.adj'
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%  # Final renaming: p_raw→p, p.adj→p_adj_holm
    mutate(item = recode(item, !!!financial_labels))
}

kable(mw_age_fin, digits = 3, caption = "Financial: Age Group Comparisons (Mann-Whitney U)")

# Gender comparisons
mw_gender_fin <- financial_long %>%
  filter(!is.na(gender_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ gender_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_gender_fin) > 0) {
  mw_gender_fin <- mw_gender_fin %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!financial_labels))
}

kable(mw_gender_fin, digits = 3, caption = "Financial: Gender Comparisons (Mann-Whitney U)")

# Position comparisons
mw_position_fin <- financial_long %>%
  filter(!is.na(position)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ position, exact = FALSE) %>%
  ungroup()

if (nrow(mw_position_fin) > 0) {
  mw_position_fin <- mw_position_fin %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!financial_labels))
}

kable(mw_position_fin, digits = 3, caption = "Financial: Position Comparisons (Mann-Whitney U)")

# Military comparisons
mw_military_fin <- financial_long %>%
  filter(!is.na(military_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ military_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_military_fin) > 0) {
  mw_military_fin <- mw_military_fin %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!financial_labels))
}

kable(mw_military_fin, digits = 3, caption = "Financial: Military Comparisons (Mann-Whitney U)")

# Experience quartile comparisons (Kruskal-Wallis)
kw_exp_fin <- financial_long %>%
  filter(!is.na(exp_q)) %>%
  group_by(item) %>%
  safe_kruskal_test(rank ~ exp_q) %>%
  ungroup()

if (nrow(kw_exp_fin) > 0) {
  kw_exp_fin <- kw_exp_fin %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, df, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!financial_labels))
}

kable(kw_exp_fin, digits = 3, caption = "Financial: Experience Comparisons (Kruskal-Wallis)")

# Save tables to CSV
write_csv(financial_desc, "../../output/tables/subfactor_analysis/financial_descriptive.csv")
write_csv(friedman_financial, "../../output/tables/subfactor_analysis/financial_friedman.csv")
if (nrow(mw_age_fin) > 0) write_csv(mw_age_fin, "../../output/tables/subfactor_analysis/financial_age.csv")
if (nrow(mw_gender_fin) > 0) write_csv(mw_gender_fin, "../../output/tables/subfactor_analysis/financial_gender.csv")
if (nrow(mw_position_fin) > 0) write_csv(mw_position_fin, "../../output/tables/subfactor_analysis/financial_position.csv")
if (nrow(mw_military_fin) > 0) write_csv(mw_military_fin, "../../output/tables/subfactor_analysis/financial_military.csv")
if (nrow(kw_exp_fin) > 0) write_csv(kw_exp_fin, "../../output/tables/subfactor_analysis/financial_experience.csv")

# Collect minimum p-value for screening
min_p_financial <- min(
  if(nrow(mw_age_fin) > 0) min(mw_age_fin$p) else 1,
  if(nrow(mw_gender_fin) > 0) min(mw_gender_fin$p) else 1,
  if(nrow(mw_position_fin) > 0) min(mw_position_fin$p) else 1,
  if(nrow(mw_military_fin) > 0) min(mw_military_fin$p) else 1,
  if(nrow(kw_exp_fin) > 0) min(kw_exp_fin$p) else 1
)

screening_results <- screening_results %>%
  add_row(
    construct = "Financial",
    min_p = min_p_financial,
    n_subfactors = 6
  )

cat("Financial screening p-value:", round(min_p_financial, 4), "\n")
```

# Quality of Life Subfactors

```{r qol}
cat("\n========================================\n")
cat("QUALITY OF LIFE SUBFACTORS\n")
cat("========================================\n\n")

# Convert to long format
qol_long <- included_data %>%
  select(age_group, gender_clean, position, exp_q, military_clean,
         qo_l_1:qo_l_6) %>%
  mutate(respondent_id = row_number()) %>%  # Create persistent ID before pivoting
  mutate(across(qo_l_1:qo_l_6, as.numeric)) %>%
  pivot_longer(
    cols = qo_l_1:qo_l_6,
    names_to = "item",
    values_to = "rank"
  ) %>%
  filter(!is.na(rank))

# Descriptive stats
qol_desc <- qol_long %>%
  group_by(item) %>%
  summarise(
    n = n(),
    median = median(rank),
    mean = mean(rank),
    sd = sd(rank),
    pct_rank1 = sum(rank == 1) / n() * 100
  ) %>%
  mutate(item = recode(item, !!!qol_labels))

kable(qol_desc, digits = 2, caption = "QoL Subfactors - Descriptive Statistics")

# Friedman test
friedman_qol <- qol_long %>%
  friedman_test(rank ~ item | respondent_id)

kable(friedman_qol, digits = 3, caption = "QoL: Friedman Test (Within-Construct Comparison)")

# Median rank visualization
qol_plot <- qol_desc %>%
  mutate(item = fct_reorder(item, desc(median))) %>%
  ggplot(aes(x = median, y = item)) +
  geom_col(fill = "forestgreen", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.1f", median)), hjust = -0.2, size = 3) +
  labs(
    title = "Quality of Life Subfactor Priorities",
    subtitle = "Median rank (lower = higher priority)",
    x = "Median Rank",
    y = NULL
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

print(qol_plot)
ggsave("../../output/figures/subfactor_analysis/qol_median_ranks.png",
       qol_plot, width = 8, height = 5, dpi = 300)

# Age group
mw_age_qol <- qol_long %>%
  filter(!is.na(age_group)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ age_group, exact = FALSE) %>%
  ungroup()

if (nrow(mw_age_qol) > 0) {
  mw_age_qol <- mw_age_qol %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!qol_labels))
}

kable(mw_age_qol, digits = 3, caption = "QoL: Age Group Comparisons")

# Gender
mw_gender_qol <- qol_long %>%
  filter(!is.na(gender_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ gender_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_gender_qol) > 0) {
  mw_gender_qol <- mw_gender_qol %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!qol_labels))
}

kable(mw_gender_qol, digits = 3, caption = "QoL: Gender Comparisons")

# Position
mw_position_qol <- qol_long %>%
  filter(!is.na(position)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ position, exact = FALSE) %>%
  ungroup()

if (nrow(mw_position_qol) > 0) {
  mw_position_qol <- mw_position_qol %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!qol_labels))
}

kable(mw_position_qol, digits = 3, caption = "QoL: Position Comparisons")

# Military
mw_military_qol <- qol_long %>%
  filter(!is.na(military_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ military_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_military_qol) > 0) {
  mw_military_qol <- mw_military_qol %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!qol_labels))
}

kable(mw_military_qol, digits = 3, caption = "QoL: Military Comparisons")

# Experience
kw_exp_qol <- qol_long %>%
  filter(!is.na(exp_q)) %>%
  group_by(item) %>%
  safe_kruskal_test(rank ~ exp_q) %>%
  ungroup()

if (nrow(kw_exp_qol) > 0) {
  kw_exp_qol <- kw_exp_qol %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, df, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!qol_labels))
}

kable(kw_exp_qol, digits = 3, caption = "QoL: Experience Comparisons")

# Save tables to CSV
write_csv(qol_desc, "../../output/tables/subfactor_analysis/qol_descriptive.csv")
write_csv(friedman_qol, "../../output/tables/subfactor_analysis/qol_friedman.csv")
if (nrow(mw_age_qol) > 0) write_csv(mw_age_qol, "../../output/tables/subfactor_analysis/qol_age.csv")
if (nrow(mw_gender_qol) > 0) write_csv(mw_gender_qol, "../../output/tables/subfactor_analysis/qol_gender.csv")
if (nrow(mw_position_qol) > 0) write_csv(mw_position_qol, "../../output/tables/subfactor_analysis/qol_position.csv")
if (nrow(mw_military_qol) > 0) write_csv(mw_military_qol, "../../output/tables/subfactor_analysis/qol_military.csv")
if (nrow(kw_exp_qol) > 0) write_csv(kw_exp_qol, "../../output/tables/subfactor_analysis/qol_experience.csv")

# Collect minimum p-value for screening
min_p_qol <- min(
  if(nrow(mw_age_qol) > 0) min(mw_age_qol$p) else 1,
  if(nrow(mw_gender_qol) > 0) min(mw_gender_qol$p) else 1,
  if(nrow(mw_position_qol) > 0) min(mw_position_qol$p) else 1,
  if(nrow(mw_military_qol) > 0) min(mw_military_qol$p) else 1,
  if(nrow(kw_exp_qol) > 0) min(kw_exp_qol$p) else 1
)

screening_results <- screening_results %>%
  add_row(
    construct = "Quality of Life",
    min_p = min_p_qol,
    n_subfactors = 6
  )

cat("Quality of Life screening p-value:", round(min_p_qol, 4), "\n")
```

# Professional Subfactors

```{r professional}
cat("\n========================================\n")
cat("PROFESSIONAL SUBFACTORS\n")
cat("========================================\n\n")

professional_long <- included_data %>%
  select(age_group, gender_clean, position, exp_q, military_clean,
         professional_1:professional_5) %>%
  mutate(respondent_id = row_number()) %>%  # Create persistent ID before pivoting
  mutate(across(professional_1:professional_5, as.numeric)) %>%
  pivot_longer(
    cols = professional_1:professional_5,
    names_to = "item",
    values_to = "rank"
  ) %>%
  filter(!is.na(rank))

# Descriptive
professional_desc <- professional_long %>%
  group_by(item) %>%
  summarise(n = n(), median = median(rank), mean = mean(rank),
            sd = sd(rank), pct_rank1 = sum(rank == 1) / n() * 100) %>%
  mutate(item = recode(item, !!!professional_labels))
kable(professional_desc, digits = 2, caption = "Professional Subfactors - Descriptive Statistics")

# Friedman
friedman_prof <- professional_long %>%
  friedman_test(rank ~ item | respondent_id)
kable(friedman_prof, digits = 3, caption = "Professional: Friedman Test (Within-Construct Comparison)")

# Median rank visualization
professional_plot <- professional_desc %>%
  mutate(item = fct_reorder(item, desc(median))) %>%
  ggplot(aes(x = median, y = item)) +
  geom_col(fill = "darkorange", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.1f", median)), hjust = -0.2, size = 3) +
  labs(
    title = "Professional Opportunity Subfactor Priorities",
    subtitle = "Median rank (lower = higher priority)",
    x = "Median Rank",
    y = NULL
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

print(professional_plot)
ggsave("../../output/figures/subfactor_analysis/professional_median_ranks.png",
       professional_plot, width = 8, height = 5, dpi = 300)

# Demographics
mw_age_prof <- professional_long %>%
  filter(!is.na(age_group)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ age_group, exact = FALSE) %>%
  ungroup()

if (nrow(mw_age_prof) > 0) {
  mw_age_prof <- mw_age_prof %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!professional_labels))
}

kable(mw_age_prof, digits = 3, caption = "Professional: Age Comparisons")

mw_gender_prof <- professional_long %>%
  filter(!is.na(gender_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ gender_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_gender_prof) > 0) {
  mw_gender_prof <- mw_gender_prof %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!professional_labels))
}

kable(mw_gender_prof, digits = 3, caption = "Professional: Gender Comparisons")

mw_position_prof <- professional_long %>%
  filter(!is.na(position)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ position, exact = FALSE) %>%
  ungroup()

if (nrow(mw_position_prof) > 0) {
  mw_position_prof <- mw_position_prof %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!professional_labels))
}

kable(mw_position_prof, digits = 3, caption = "Professional: Position Comparisons")

mw_military_prof <- professional_long %>%
  filter(!is.na(military_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ military_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_military_prof) > 0) {
  mw_military_prof <- mw_military_prof %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!professional_labels))
}

kable(mw_military_prof, digits = 3, caption = "Professional: Military Comparisons")

kw_exp_prof <- professional_long %>%
  filter(!is.na(exp_q)) %>%
  group_by(item) %>%
  safe_kruskal_test(rank ~ exp_q) %>%
  ungroup()

if (nrow(kw_exp_prof) > 0) {
  kw_exp_prof <- kw_exp_prof %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, df, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!professional_labels))
}

kable(kw_exp_prof, digits = 3, caption = "Professional: Experience Comparisons")

# Save tables to CSV
write_csv(professional_desc, "../../output/tables/subfactor_analysis/professional_descriptive.csv")
write_csv(friedman_prof, "../../output/tables/subfactor_analysis/professional_friedman.csv")
if (nrow(mw_age_prof) > 0) write_csv(mw_age_prof, "../../output/tables/subfactor_analysis/professional_age.csv")
if (nrow(mw_gender_prof) > 0) write_csv(mw_gender_prof, "../../output/tables/subfactor_analysis/professional_gender.csv")
if (nrow(mw_position_prof) > 0) write_csv(mw_position_prof, "../../output/tables/subfactor_analysis/professional_position.csv")
if (nrow(mw_military_prof) > 0) write_csv(mw_military_prof, "../../output/tables/subfactor_analysis/professional_military.csv")
if (nrow(kw_exp_prof) > 0) write_csv(kw_exp_prof, "../../output/tables/subfactor_analysis/professional_experience.csv")

# Collect minimum p-value for screening
min_p_prof <- min(
  if(nrow(mw_age_prof) > 0) min(mw_age_prof$p) else 1,
  if(nrow(mw_gender_prof) > 0) min(mw_gender_prof$p) else 1,
  if(nrow(mw_position_prof) > 0) min(mw_position_prof$p) else 1,
  if(nrow(mw_military_prof) > 0) min(mw_military_prof$p) else 1,
  if(nrow(kw_exp_prof) > 0) min(kw_exp_prof$p) else 1
)

screening_results <- screening_results %>%
  add_row(
    construct = "Professional",
    min_p = min_p_prof,
    n_subfactors = 5
  )

cat("Professional screening p-value:", round(min_p_prof, 4), "\n")
```

# Recognition Subfactors

```{r recognition}
cat("\n========================================\n")
cat("RECOGNITION SUBFACTORS\n")
cat("========================================\n\n")

recognition_long <- included_data %>%
  select(age_group, gender_clean, position, exp_q, military_clean,
         recognition_1, recognition_3, recognition_4, recognition_7) %>%
  mutate(respondent_id = row_number()) %>%  # Create persistent ID before pivoting
  mutate(across(starts_with("recognition"), as.numeric)) %>%
  pivot_longer(
    cols = starts_with("recognition"),
    names_to = "item",
    values_to = "rank"
  ) %>%
  filter(!is.na(rank))

# Descriptive
recognition_desc <- recognition_long %>%
  group_by(item) %>%
  summarise(n = n(), median = median(rank), mean = mean(rank),
            sd = sd(rank), pct_rank1 = sum(rank == 1) / n() * 100) %>%
  mutate(item = recode(item, !!!recognition_labels))
kable(recognition_desc, digits = 2, caption = "Recognition Subfactors - Descriptive Statistics")

# Friedman
friedman_recog <- recognition_long %>%
  friedman_test(rank ~ item | respondent_id)
kable(friedman_recog, digits = 3, caption = "Recognition: Friedman Test (Within-Construct Comparison)")

# Median rank visualization
recognition_plot <- recognition_desc %>%
  mutate(item = fct_reorder(item, desc(median))) %>%
  ggplot(aes(x = median, y = item)) +
  geom_col(fill = "purple", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.1f", median)), hjust = -0.2, size = 3) +
  labs(
    title = "Recognition Subfactor Priorities",
    subtitle = "Median rank (lower = higher priority)",
    x = "Median Rank",
    y = NULL
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

print(recognition_plot)
ggsave("../../output/figures/subfactor_analysis/recognition_median_ranks.png",
       recognition_plot, width = 8, height = 5, dpi = 300)

# Demographics
mw_age_recog <- recognition_long %>%
  filter(!is.na(age_group)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ age_group, exact = FALSE) %>%
  ungroup()

if (nrow(mw_age_recog) > 0) {
  mw_age_recog <- mw_age_recog %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!recognition_labels))
}

kable(mw_age_recog, digits = 3, caption = "Recognition: Age Comparisons")

mw_gender_recog <- recognition_long %>%
  filter(!is.na(gender_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ gender_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_gender_recog) > 0) {
  mw_gender_recog <- mw_gender_recog %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!recognition_labels))
}

kable(mw_gender_recog, digits = 3, caption = "Recognition: Gender Comparisons")

mw_position_recog <- recognition_long %>%
  filter(!is.na(position)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ position, exact = FALSE) %>%
  ungroup()

if (nrow(mw_position_recog) > 0) {
  mw_position_recog <- mw_position_recog %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!recognition_labels))
}

kable(mw_position_recog, digits = 3, caption = "Recognition: Position Comparisons")

mw_military_recog <- recognition_long %>%
  filter(!is.na(military_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ military_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_military_recog) > 0) {
  mw_military_recog <- mw_military_recog %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!recognition_labels))
}

kable(mw_military_recog, digits = 3, caption = "Recognition: Military Comparisons")

kw_exp_recog <- recognition_long %>%
  filter(!is.na(exp_q)) %>%
  group_by(item) %>%
  safe_kruskal_test(rank ~ exp_q) %>%
  ungroup()

if (nrow(kw_exp_recog) > 0) {
  kw_exp_recog <- kw_exp_recog %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, df, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!recognition_labels))
}

kable(kw_exp_recog, digits = 3, caption = "Recognition: Experience Comparisons")

# Save tables to CSV
write_csv(recognition_desc, "../../output/tables/subfactor_analysis/recognition_descriptive.csv")
write_csv(friedman_recog, "../../output/tables/subfactor_analysis/recognition_friedman.csv")
if (nrow(mw_age_recog) > 0) write_csv(mw_age_recog, "../../output/tables/subfactor_analysis/recognition_age.csv")
if (nrow(mw_gender_recog) > 0) write_csv(mw_gender_recog, "../../output/tables/subfactor_analysis/recognition_gender.csv")
if (nrow(mw_position_recog) > 0) write_csv(mw_position_recog, "../../output/tables/subfactor_analysis/recognition_position.csv")
if (nrow(mw_military_recog) > 0) write_csv(mw_military_recog, "../../output/tables/subfactor_analysis/recognition_military.csv")
if (nrow(kw_exp_recog) > 0) write_csv(kw_exp_recog, "../../output/tables/subfactor_analysis/recognition_experience.csv")

# Collect minimum p-value for screening
min_p_recog <- min(
  if(nrow(mw_age_recog) > 0) min(mw_age_recog$p) else 1,
  if(nrow(mw_gender_recog) > 0) min(mw_gender_recog$p) else 1,
  if(nrow(mw_position_recog) > 0) min(mw_position_recog$p) else 1,
  if(nrow(mw_military_recog) > 0) min(mw_military_recog$p) else 1,
  if(nrow(kw_exp_recog) > 0) min(kw_exp_recog$p) else 1
)

screening_results <- screening_results %>%
  add_row(
    construct = "Recognition",
    min_p = min_p_recog,
    n_subfactors = 4
  )

cat("Recognition screening p-value:", round(min_p_recog, 4), "\n")
```

# Schedule Subfactors

```{r schedule}
cat("\n========================================\n")
cat("SCHEDULE SUBFACTORS\n")
cat("========================================\n\n")

schedule_long <- included_data %>%
  select(age_group, gender_clean, position, exp_q, military_clean,
         schedule_1:schedule_5) %>%
  mutate(respondent_id = row_number()) %>%  # Create persistent ID before pivoting
  mutate(across(schedule_1:schedule_5, as.numeric)) %>%
  pivot_longer(
    cols = schedule_1:schedule_5,
    names_to = "item",
    values_to = "rank"
  ) %>%
  filter(!is.na(rank))

# Descriptive
schedule_desc <- schedule_long %>%
  group_by(item) %>%
  summarise(n = n(), median = median(rank), mean = mean(rank),
            sd = sd(rank), pct_rank1 = sum(rank == 1) / n() * 100) %>%
  mutate(item = recode(item, !!!schedule_labels))
kable(schedule_desc, digits = 2, caption = "Schedule Subfactors - Descriptive Statistics")

# Friedman
friedman_sched <- schedule_long %>%
  friedman_test(rank ~ item | respondent_id)
kable(friedman_sched, digits = 3, caption = "Schedule: Friedman Test (Within-Construct Comparison)")

# Median rank visualization
schedule_plot <- schedule_desc %>%
  mutate(item = fct_reorder(item, desc(median))) %>%
  ggplot(aes(x = median, y = item)) +
  geom_col(fill = "firebrick", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.1f", median)), hjust = -0.2, size = 3) +
  labs(
    title = "Schedule Subfactor Priorities",
    subtitle = "Median rank (lower = higher priority)",
    x = "Median Rank",
    y = NULL
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

print(schedule_plot)
ggsave("../../output/figures/subfactor_analysis/schedule_median_ranks.png",
       schedule_plot, width = 8, height = 5, dpi = 300)

# Demographics
mw_age_sched <- schedule_long %>%
  filter(!is.na(age_group)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ age_group, exact = FALSE) %>%
  ungroup()

if (nrow(mw_age_sched) > 0) {
  mw_age_sched <- mw_age_sched %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!schedule_labels))
}

kable(mw_age_sched, digits = 3, caption = "Schedule: Age Comparisons")

mw_gender_sched <- schedule_long %>%
  filter(!is.na(gender_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ gender_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_gender_sched) > 0) {
  mw_gender_sched <- mw_gender_sched %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!schedule_labels))
}

kable(mw_gender_sched, digits = 3, caption = "Schedule: Gender Comparisons")

mw_position_sched <- schedule_long %>%
  filter(!is.na(position)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ position, exact = FALSE) %>%
  ungroup()

if (nrow(mw_position_sched) > 0) {
  mw_position_sched <- mw_position_sched %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!schedule_labels))
}

kable(mw_position_sched, digits = 3, caption = "Schedule: Position Comparisons")

mw_military_sched <- schedule_long %>%
  filter(!is.na(military_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ military_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_military_sched) > 0) {
  mw_military_sched <- mw_military_sched %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!schedule_labels))
}

kable(mw_military_sched, digits = 3, caption = "Schedule: Military Comparisons")

kw_exp_sched <- schedule_long %>%
  filter(!is.na(exp_q)) %>%
  group_by(item) %>%
  safe_kruskal_test(rank ~ exp_q) %>%
  ungroup()

if (nrow(kw_exp_sched) > 0) {
  kw_exp_sched <- kw_exp_sched %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, df, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!schedule_labels))
}

kable(kw_exp_sched, digits = 3, caption = "Schedule: Experience Comparisons")

# Save tables to CSV
write_csv(schedule_desc, "../../output/tables/subfactor_analysis/schedule_descriptive.csv")
write_csv(friedman_sched, "../../output/tables/subfactor_analysis/schedule_friedman.csv")
if (nrow(mw_age_sched) > 0) write_csv(mw_age_sched, "../../output/tables/subfactor_analysis/schedule_age.csv")
if (nrow(mw_gender_sched) > 0) write_csv(mw_gender_sched, "../../output/tables/subfactor_analysis/schedule_gender.csv")
if (nrow(mw_position_sched) > 0) write_csv(mw_position_sched, "../../output/tables/subfactor_analysis/schedule_position.csv")
if (nrow(mw_military_sched) > 0) write_csv(mw_military_sched, "../../output/tables/subfactor_analysis/schedule_military.csv")
if (nrow(kw_exp_sched) > 0) write_csv(kw_exp_sched, "../../output/tables/subfactor_analysis/schedule_experience.csv")

# Collect minimum p-value for screening
min_p_sched <- min(
  if(nrow(mw_age_sched) > 0) min(mw_age_sched$p) else 1,
  if(nrow(mw_gender_sched) > 0) min(mw_gender_sched$p) else 1,
  if(nrow(mw_position_sched) > 0) min(mw_position_sched$p) else 1,
  if(nrow(mw_military_sched) > 0) min(mw_military_sched$p) else 1,
  if(nrow(kw_exp_sched) > 0) min(kw_exp_sched$p) else 1
)

screening_results <- screening_results %>%
  add_row(
    construct = "Schedule",
    min_p = min_p_sched,
    n_subfactors = 5
  )

cat("Schedule screening p-value:", round(min_p_sched, 4), "\n")
```

# Operational Subfactors

```{r operational}
cat("\n========================================\n")
cat("OPERATIONAL SUBFACTORS\n")
cat("========================================\n\n")

operational_long <- included_data %>%
  select(age_group, gender_clean, position, exp_q, military_clean,
         operational_1:operational_5) %>%
  mutate(respondent_id = row_number()) %>%  # Create persistent ID before pivoting
  mutate(across(operational_1:operational_5, as.numeric)) %>%
  pivot_longer(
    cols = operational_1:operational_5,
    names_to = "item",
    values_to = "rank"
  ) %>%
  filter(!is.na(rank))

# Descriptive
operational_desc <- operational_long %>%
  group_by(item) %>%
  summarise(n = n(), median = median(rank), mean = mean(rank),
            sd = sd(rank), pct_rank1 = sum(rank == 1) / n() * 100) %>%
  mutate(item = recode(item, !!!operational_labels))
kable(operational_desc, digits = 2, caption = "Operational Subfactors - Descriptive Statistics")

# Friedman
friedman_oper <- operational_long %>%
  friedman_test(rank ~ item | respondent_id)
kable(friedman_oper, digits = 3, caption = "Operational: Friedman Test (Within-Construct Comparison)")

# Median rank visualization
operational_plot <- operational_desc %>%
  mutate(item = fct_reorder(item, desc(median))) %>%
  ggplot(aes(x = median, y = item)) +
  geom_col(fill = "darkslategray", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.1f", median)), hjust = -0.2, size = 3) +
  labs(
    title = "Operational Subfactor Priorities",
    subtitle = "Median rank (lower = higher priority)",
    x = "Median Rank",
    y = NULL
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

print(operational_plot)
ggsave("../../output/figures/subfactor_analysis/operational_median_ranks.png",
       operational_plot, width = 8, height = 5, dpi = 300)

# Demographics
mw_age_oper <- operational_long %>%
  filter(!is.na(age_group)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ age_group, exact = FALSE) %>%
  ungroup()

if (nrow(mw_age_oper) > 0) {
  mw_age_oper <- mw_age_oper %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!operational_labels))
}

kable(mw_age_oper, digits = 3, caption = "Operational: Age Comparisons")

mw_gender_oper <- operational_long %>%
  filter(!is.na(gender_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ gender_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_gender_oper) > 0) {
  mw_gender_oper <- mw_gender_oper %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!operational_labels))
}

kable(mw_gender_oper, digits = 3, caption = "Operational: Gender Comparisons")

mw_position_oper <- operational_long %>%
  filter(!is.na(position)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ position, exact = FALSE) %>%
  ungroup()

if (nrow(mw_position_oper) > 0) {
  mw_position_oper <- mw_position_oper %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!operational_labels))
}

kable(mw_position_oper, digits = 3, caption = "Operational: Position Comparisons")

mw_military_oper <- operational_long %>%
  filter(!is.na(military_clean)) %>%
  group_by(item) %>%
  safe_wilcox_test(rank ~ military_clean, exact = FALSE) %>%
  ungroup()

if (nrow(mw_military_oper) > 0) {
  mw_military_oper <- mw_military_oper %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!operational_labels))
}

kable(mw_military_oper, digits = 3, caption = "Operational: Military Comparisons")

kw_exp_oper <- operational_long %>%
  filter(!is.na(exp_q)) %>%
  group_by(item) %>%
  safe_kruskal_test(rank ~ exp_q) %>%
  ungroup()

if (nrow(kw_exp_oper) > 0) {
  kw_exp_oper <- kw_exp_oper %>%
    mutate(p_raw = p) %>%
    adjust_pvalue(method = "holm") %>%
    add_significance("p.adj") %>%
    select(item, statistic, df, p_raw, p.adj, p.adj.signif, effsize, magnitude) %>%
    rename(p = p_raw, p_adj_holm = p.adj) %>%
    mutate(item = recode(item, !!!operational_labels))
}

kable(kw_exp_oper, digits = 3, caption = "Operational: Experience Comparisons")

# Save tables to CSV
write_csv(operational_desc, "../../output/tables/subfactor_analysis/operational_descriptive.csv")
write_csv(friedman_oper, "../../output/tables/subfactor_analysis/operational_friedman.csv")
if (nrow(mw_age_oper) > 0) write_csv(mw_age_oper, "../../output/tables/subfactor_analysis/operational_age.csv")
if (nrow(mw_gender_oper) > 0) write_csv(mw_gender_oper, "../../output/tables/subfactor_analysis/operational_gender.csv")
if (nrow(mw_position_oper) > 0) write_csv(mw_position_oper, "../../output/tables/subfactor_analysis/operational_position.csv")
if (nrow(mw_military_oper) > 0) write_csv(mw_military_oper, "../../output/tables/subfactor_analysis/operational_military.csv")
if (nrow(kw_exp_oper) > 0) write_csv(kw_exp_oper, "../../output/tables/subfactor_analysis/operational_experience.csv")

# Collect minimum p-value for screening
min_p_oper <- min(
  if(nrow(mw_age_oper) > 0) min(mw_age_oper$p) else 1,
  if(nrow(mw_gender_oper) > 0) min(mw_gender_oper$p) else 1,
  if(nrow(mw_position_oper) > 0) min(mw_position_oper$p) else 1,
  if(nrow(mw_military_oper) > 0) min(mw_military_oper$p) else 1,
  if(nrow(kw_exp_oper) > 0) min(kw_exp_oper$p) else 1
)

screening_results <- screening_results %>%
  add_row(
    construct = "Operational",
    min_p = min_p_oper,
    n_subfactors = 5
  )

cat("Operational screening p-value:", round(min_p_oper, 4), "\n")
```

# Construct-Level Screening Results

```{r screening-results}
# Apply Benjamini-Hochberg FDR to Screening Results
# ==================================================

cat("\n=== FINAL SCREENING RESULTS ===\n\n")

# Apply BH-FDR at q=0.10
screening_results <- screening_results %>%
  arrange(min_p) %>%
  mutate(
    rank = row_number(),
    p_adj_fdr = p.adjust(min_p, method = "BH"),
    significant = p_adj_fdr < 0.10,
    decision = if_else(significant, "Proceed to detailed testing", "No demographic differences detected")
  )

# Display results
kable(
  screening_results %>% select(construct, min_p, p_adj_fdr, significant, n_subfactors, decision),
  digits = 4,
  caption = "Construct-Level Screening: Benjamini-Hochberg FDR (q=0.10)",
  col.names = c("Construct", "Min p-value", "p-adj (FDR)", "Significant", "N Subfactors", "Decision")
)

# Count significant constructs
n_significant <- sum(screening_results$significant)
cat("\nSignificant constructs (p_adj < 0.10):", n_significant, "of 6\n")

# Interpretation guidance
if (n_significant > 0) {
  cat("\nFor constructs passing screening (p_adj < 0.10):\n")
  cat("  Demographic comparisons within these constructs have been adjusted using\n")
  cat("  Holm's procedure at α=0.05. Tests with p_adj_holm < 0.05 indicate\n")
  cat("  specific demographics showing differences in subfactor rankings.\n\n")

  cat("For constructs NOT passing screening:\n")
  cat("  No evidence of demographic differences at construct level.\n")
  cat("  Individual demographic comparisons should be interpreted as exploratory only.\n")
} else {
  cat("\nNo constructs showed significant demographic differences at construct level.\n")
  cat("Individual demographic comparisons reported above are retained for completeness\n")
  cat("and should be treated as exploratory outputs without confirmatory claims.\n")
}
```

# Results Summary

```{r subfactor-summary-table}
count_sig <- function(tbl_name) {
  if (!exists(tbl_name, inherits = TRUE)) return(0)
  df <- get(tbl_name, inherits = TRUE)
  if (!"p_adj_holm" %in% names(df)) return(0)
  sum(df$p_adj_holm < 0.05, na.rm = TRUE)
}

count_tests <- function(tbl_name) {
  if (!exists(tbl_name, inherits = TRUE)) return(0)
  nrow(get(tbl_name, inherits = TRUE))
}

detailed_summary <- tibble::tibble(
  Construct = c("Financial", "Quality of Life", "Professional", "Recognition", "Schedule", "Operational"),
  Age_tests = c(count_tests("mw_age_fin"), count_tests("mw_age_qol"), count_tests("mw_age_prof"),
                count_tests("mw_age_recog"), count_tests("mw_age_sched"), count_tests("mw_age_oper")),
  Age_significant = c(count_sig("mw_age_fin"), count_sig("mw_age_qol"), count_sig("mw_age_prof"),
                      count_sig("mw_age_recog"), count_sig("mw_age_sched"), count_sig("mw_age_oper")),
  Gender_tests = c(count_tests("mw_gender_fin"), count_tests("mw_gender_qol"), count_tests("mw_gender_prof"),
                   count_tests("mw_gender_recog"), count_tests("mw_gender_sched"), count_tests("mw_gender_oper")),
  Gender_significant = c(count_sig("mw_gender_fin"), count_sig("mw_gender_qol"), count_sig("mw_gender_prof"),
                         count_sig("mw_gender_recog"), count_sig("mw_gender_sched"), count_sig("mw_gender_oper")),
  Position_tests = c(count_tests("mw_position_fin"), count_tests("mw_position_qol"), count_tests("mw_position_prof"),
                     count_tests("mw_position_recog"), count_tests("mw_position_sched"), count_tests("mw_position_oper")),
  Position_significant = c(count_sig("mw_position_fin"), count_sig("mw_position_qol"), count_sig("mw_position_prof"),
                           count_sig("mw_position_recog"), count_sig("mw_position_sched"), count_sig("mw_position_oper")),
  Military_tests = c(count_tests("mw_military_fin"), count_tests("mw_military_qol"), count_tests("mw_military_prof"),
                     count_tests("mw_military_recog"), count_tests("mw_military_sched"), count_tests("mw_military_oper")),
  Military_significant = c(count_sig("mw_military_fin"), count_sig("mw_military_qol"), count_sig("mw_military_prof"),
                           count_sig("mw_military_recog"), count_sig("mw_military_sched"), count_sig("mw_military_oper")),
  Experience_tests = c(count_tests("kw_exp_fin"), count_tests("kw_exp_qol"), count_tests("kw_exp_prof"),
                       count_tests("kw_exp_recog"), count_tests("kw_exp_sched"), count_tests("kw_exp_oper")),
  Experience_significant = c(count_sig("kw_exp_fin"), count_sig("kw_exp_qol"), count_sig("kw_exp_prof"),
                             count_sig("kw_exp_recog"), count_sig("kw_exp_sched"), count_sig("kw_exp_oper"))
)

knitr::kable(
  detailed_summary,
  caption = "Counts of Holm-Adjusted Comparisons Below 0.05 by Construct and Demographic Group"
)
```

# Conclusion

This analysis examined 31 subfactor rankings across six retention constructs (Financial, Quality of Life, Professional Opportunity, Recognition, Schedule, and Operational) and compared them across five demographic groups: age (≤35 vs >35), gender, position (Captain vs First Officer), military experience, and years of experience (quartiles).

**Statistical Methods:** This exploratory pilot study employed a two-step hierarchical false discovery rate (FDR) control procedure. First, construct-level screening using Benjamini-Hochberg FDR at q=0.10 determined which of the six constructs showed demographic differences. Second, for constructs passing screening, individual demographic comparisons were adjusted using Holm's procedure at α=0.05. Mann-Whitney U tests were used for binary demographic comparisons, Kruskal-Wallis tests for experience quartiles, and Friedman tests for within-construct comparisons. All tests used proper respondent identifiers to maintain the repeated-measures structure of the data. Effect sizes (rank-biserial r for Mann-Whitney, eta-squared for Kruskal-Wallis) were computed for every test.

**Key Outputs:** Construct-level screening results, detailed demographic tables (with raw and Holm-adjusted p-values), effect sizes (|r| < 0.3, η² < 0.06 across all tests), and median-rank visualizations are provided above.

## Sample Characteristics

This analysis is based on n=76 valid pilot responses. Demographic breakdown used in testing:

- Age groups: ≤35 (58 pilots) and >35 (18 pilots)
- Gender: Male (67), Female (8); other/unspecified entries were excluded from binary comparisons
- Position: Captain (26) and First Officer (50)
- Military background: Military (7) and Civilian (69)
- Experience quartiles: ntile-based groups containing 28 (Q1), 14 (Q2), 17 (Q3), and 17 (Q4) pilots, respectively

Effect sizes for all demographic comparisons were within |r| < 0.3 for Mann-Whitney tests and η² < 0.06 for Kruskal-Wallis tests.

# Session Info

```{r session}
sessionInfo()
```
